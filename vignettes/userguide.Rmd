---
title: "Cardiocyte Guide"
output: 
  BiocStyle::html_document:
    toc_float: true
vignette: >
  %\VignetteIndexEntry{Cardiocyte Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

Being able to measure and quantify the intensity of cardiomyocyte contraction is very important in developing treatments for cardiovascular diseases that damage cardiac tissue. Cardiomyocyte contraction can be quantified by measuring the flux of Calcium ions across the cell's cytoplasm. This R package contains several tools that make analyzing calcium flux data much more convenient. Becuase calcium flux is transient (departs from a baseline, then returns to it, and repeats) it can be measured in terms of peaks and/or pulses. This package includes functions that help measure and quantify these peaks and pulses. 


```{r setup}
library(cardiocyte)
```

# Peak metrics

## Identify pikes with `find_peaks()`

this function takes a dataset from an ImageJ image stack (A video of calcium flux in a cardiomyocyte, in this case **"ca_flux"**), as well as a Mean from a chosen ROI (region of interest, usually membrane surface above cytoplasm), and returns the slice where each peak is located. 

Example (using ca_flux as the dataset, ROI 1, and ROI 2): 
```{r}

find_peaks(ca_flux$Mean1)

find_peaks(ca_flux$Mean2)
```


## peak_height()

this function takes the ImageJ dataset, as well as the Mean from a chosen ROI, and returns the height of each peak (the y value, or the maximum quantified calcium flux deviation from the established baseline). 

```{r}
peak_height(ca_flux$Mean1)

peak_height(ca_flux$Mean2)
```
## ensemble()

This function takes an ImageJ dataset and a specified ROI and extracts all the curves from the ImageJ trace data. 

```{r}
(dat <- ensemble(ca_flux$Mean1))

dat2 <- ensemble(ca_flux$Mean2)
```

## pulse_widths()

This function calculates the widths of pulses. It takes data from an ensemble() matrix (as described above), as well as a specified percentile (p) of the max at which to calculate width. 

```{r}
pulse_widths(dat, .9)

pulse_widths(dat2, .9)

pulse_widths(dat, .8)
```

## time_to_peak()

This function calculates the time (in slices) that it takes for a pulse to reach its maximum. The function an ImageJ dataset and an ROI Mean and starts calculating time when the pulse reaches 10% of the peak height. It returns the time calculated for the pulse to go from 10% to maximum peak height. 

```{r}
time_to_peak(ca_flux$Mean1)

time_to_peak(ca_flux$Mean2)
```

## percent_peak()

This function divides the locations of each peak by the baseline calcium flux value at each peak, then multiplies by 100. The function takes an ImageJ dataset and the Mean from a chosen ROI. 

```{r}
percent_peak(ca_flux$Mean1)

percent_peak(ca_flux$Mean2)
```

## percent_peak_height()

This function divides the heights of each peak by the baseline calcium flux value at each peak, then multiplies by 100. The function takes an ImageJ dataset and the Mean from a chosen ROI. 

```{r}
percent_peak_height(ca_flux$Mean1)

percent_peak_height(ca_flux$Mean2)
```


## max_velocities()

This function returns the maximum velocity of the transient, or the maximum slope (positive and negative) of the peaks on a visualized graph of an ImageJ dataset. The function takes an ImageJ dataset and the Mean from a chosen ROI, and returns both the slices where the maximum up (x.up) and down (x.down) velocities are located, as well as the values for the maximum up and down velocities. 

```{r}
max_velocities(ca_flux$Mean1)

```

## max_rates_baseline()

This function divides the maximum transient velocity of each peak by the baseline calcium flux at the point where the transient reaches its maximum velocity. 

```{r}
max_rates_bl(ca_flux$Mean1)

max_rates_bl(ca_flux$Mean2)
```

## max_rates_ph()

This function divides the maximum transient velocity of each peak by the height of that specific peak. 

```{r}
max_rates_ph(ca_flux$Mean1)

max_rates_ph(ca_flux$Mean2)
```

# Plotting

The cardiocyte package provides functionality to plot annotated transients, 
both in their original form and as overlays (ensemble) of all peaks.

## Annotated transients with `plot_curve()`

We can plot the transients with the plot_curve function

```{r}
plot_curve(ca_flux$Mean1)
```

The package also implements annotations as ggplot layers so you can chain the 
plots in the usual ggplot fashion:

```{r}
plot_curve(ca_flux$Mean1) +
  geom_vel("up") +
  geom_vel("down") +
  geom_peaks()

```

The effects of baseline correction can then be directly visualized.

```{r}
plot_curve(ca_flux$Mean1) +
  geom_vel("up") +
  geom_vel("down") +
  geom_peaks()

```


Finally, the curves can be extracted an overlaid in an ensemble plot together 
with an averaged curve with error bounds.The offset parameter indicates how 
many time points to drop at the start of the acquisition to assist in centering 
the curves in the ensemble window.

```{r}
plot_ensemble(ca_flux$Mean1, offset = 3, norm=FALSE) 
```

To account for bleaching over the time course, the curves can be normalized to 
standardized heights.

```{r}
plot_ensemble(ca_flux$Mean1, offset = 3, norm=TRUE) 
```


